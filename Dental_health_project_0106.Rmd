---
title: "Dental Health Project2"
author: "Lucas Zhang"
date: '2023-01-06'
output: 
  html_document:
    number_sections: true
---

Update Log:

-   2022/09/19:
    -   rewrite the data manipulation with tidyverse
    -   add smoking data into the missing value imputation model(s): ***Looking for more info***
    -   explore the distribution of la and pc values at the four sites within the same tooth: ***Do wee need to set up some rules for carrying over?***
    -   carryover exsting values in one site to other sites within the same tooth: ***Do wee need to set up some rules for carrying over?***
    -   filtering subject \< 32 sites: ***consider la and pc together or seperately? --la missing when pc missing***
    -   working on MICE
-   2022/09/26
    -   Derive `smk_stt` from `smq020` and `smq 040`. If `SMQ020` AND `SMQ040` are both positive then YES, if else NO.
        -   `smq020`: {1,2,NA} "Smoked at least 100 cigarettes in life"
        -   `smq040`: {1,2,3,NA} "Do you now smoke cigarettes"
    -   Put `smk_stt` into the model
    -   a lot of rows are lost when merging `Q4`, `SMK` and `temp1`
-   2022/09/26 (CONT.)
    -   I need to remove the MAGIC NUMBERS!!!!
    -   working on MICE
        -   Need to set up HPC to run MICE
    -   Compare MICEd data with oringinal data
-   2022/10/04
    -   Incorprated MICEd data (Done)
    -   Plot between original missing sites and new case definition using MICEd data (Done)
    -   Excluded LASSO from the report (Done), correct the SVM part
    -   NEED TO DO: Perform MICE on 100% data and Calculate AUC on the test set
    -   NEED TO DO: Update SMK data
    -   (?) Maybe I can include the \# of missing sites when MICE'ing
    -   NEED to check: the random number generator in Rmarkdown may not be the same as the Rgui. If this is the case, should not split dataset in Rmarkdown
-   2022/10/11
    -   Update SMK data (Done): need some clarification, `DEMO_H.XPT` does not have information we need.
    -   Added `num_missing_site` and `num_missing_tooth` to data and conduct MICE
    -   Performed MICE on 100% data
    -   NEEDED: values \> 10 after MICE
    -   Split data into "F" and "G" part and Calculate AUC on the test set
    -   Reviewed code: it should be correct (no data leakage)
    -   Removed almost all the magic numbers (still some in the `case_definition`)
    -   Calculated the sensitivity (\~61%) according to the case definition using Ram teeth only
    -   NEEDED: averaging over all MICEd datasets
    -   NEEDED: model selection
-   2022/12/28
    -   Aims:
        -   compare different imputation models. Compare performance of different models used in MICE (vs. prevalance).
        -   demographic table: how the demographic characteristics will change after the imputation? Demographic traits \<-\> CAL relationship. Different demographic traits / covariates \<-\> mean.AL.imputed, mean.PC.imputed
        -   confidence interval / variance of imputed dataset.

# Introduction

This is a review R markdown document for the dental health project. Adapted from "Code.R". The files of "Code2.R" looks similar with "Code.R". The file of "Code3.R" appears to give case defition and run models on *unimputed* data.

Aims:

-   to re-organize the source code based on my guess
-   to label out the missing files
-   to go through and re-run part of the source code

```{r setup, include=FALSE}
set.seed(12345678)
FIG.WIDTH = 8
RECYCLE = FALSE
library(Hmisc)
library(tidyverse)
# library(glmnet)
# library(e1071)
library(kableExtra)
# library(ROCR)
library(ggconsort)
sum.na <- function(x) sum(x,na.rm=T)
NA_num <- function(x) sum(is.na(x))
carry_over_missing_sites <- function(x){
  if(sum(!is.na(x)) == 0) return(x) else{
    length.na <- length(x[is.na(x)])
    x[is.na(x)] <- sample(x[!is.na(x)], replace = TRUE, size = length.na)
    return(x)
  }
}
case_definition <- function(d){
  sum.na <- function(x){sum(x,na.rm=T)}

  #only the pc and la columns
  num.teeth <- names(d) %>% str_subset("^ohx\\d\\d") %>% 
    str_extract("\\d\\d") %>% unique() %>% length
  pc <- d %>% select(contains("pc"))
  if(ncol(pc) != num.teeth*4) 
    stop("Number of pc measurement != 4*number of teeth")
  la <- d %>% select(contains("la"))
  if(ncol(la) != num.teeth*4) 
    stop("Number of la measurement != 4*number of teeth")

  # No
  ps <- rep("no", length = nrow(d)) 
  
  # Mild
  al.g3 <- la >= 3
  out <- 0
  for (i in 1:num.teeth){
    temp <- apply(al.g3[,(4*i-3):(4*i)], 1, sum.na) > 0
    out <- temp + out
  }
  mild.al <- out >= 2
  
  pc.g4 <- pc >= 4
  out <- 0
  for (i in 1:num.teeth){
    temp <- apply(pc.g4[,(4*i-3):(4*i)], 1, sum.na) > 0
    out <- temp + out
  }
  mild.pc4 <- out >= 2
  
  pc.g5 <- pc >= 5
  mild.pc5 <- apply(pc.g5, 1, sum.na) > 0
  
  # d$ps[((mild.pc4 * mild.al)+mild.pc5)>0] <- "mild"
  ps[(((mild.pc4 +mild.pc5)>0)*mild.al)>0] <- "mild"
  
  # Moderate
  al.g4 <- la >= 4
  out <- 0
  for (i in 1:num.teeth){
    temp <- apply(al.g4[,(4*i-3):(4*i)], 1, sum.na) > 0
    out <- temp + out
  }
  moderate.al <- out >= 2
  
  pc.g5 <- pc >= 5
  out <- 0
  for (i in 1:num.teeth){
    temp <- apply(pc.g5[,(4*i-3):(4*i)], 1, sum.na) > 0
    out <- temp + out
  }
  moderate.pc <- out >= 2
  
  ps[(moderate.pc+moderate.al) > 0] <- "mod"
  
  # Severer
  al.g6 <- la >= 6
  out <- 0
  for (i in 1:num.teeth){
    temp <- apply(al.g6[,(4*i-3):(4*i)], 1, sum.na) > 0
    out <- temp + out
  }
  severer.al <- out >= 2
  
  pc.g5 <- pc >= 5
  severer.pc5 <- apply(pc.g5, 1, sum.na) > 0
  
  ps[(severer.al*severer.pc5)>0] <- "sev"
  S <- ps=="sev"
  MS <- ps=="sev" | ps=="mod"
  d <- d %>% mutate(ps = ps, S = S, MS = MS)
  return(d)
}

calculate_metrics <- function(data = c("Original","With MICE"), 
                  method = c("Full Mouth", "naive Ramfjord", "SVM (Full Mouth)", "SVM (Ramfjord Teeth)"), 
                  case = c("Severe", "Moderate-Severe"),
                  test.d_miced = test.d_miced, test.d_orgin = test.d_orgin, 
                  train.d_miced = train.d_miced, train.d_orgin = train.d_orgin,
                  Ramfjord = Ramfjord, Full_mouth = Full_mouth,
                  digit = 1){
  if(data == "Original") {
    train <- train.d_orgin
    test <- test.d_orgin
  }else if(data == "With MICE"){
    train <- train.d_miced
    test <- test.d_miced
  }
  
  
  if(case == "Severe") {
    VAR = "S"
  }else if(case == "Moderate-Severe"){
    VAR = "MS"
  }
  true_value = pull(test, VAR) %>% as.numeric() #1/0
  
  flag_fixed <- NA
  if(method == "Full Mouth") {
    pred_value <- true_value %>% as.numeric()
    flag_fixed <- TRUE
  } else if(method == "naive Ramfjord"){
    pred_value <- test %>% select(all_of(Ramfjord)) %>% case_definition() %>% 
      pull(VAR) %>% as.numeric()
    flag_fixed <- TRUE
  } else if(method == "SVM (Ramfjord Teeth)"){
    # how to deal with the missing values when it comes to SVM???
    index <- which(names(train) %in% Full_mouth)
    for(i in index) {train[[i]] <- replace_na(train[[i]], 0); test[[i]] <- replace_na(test[[i]], 0)}
    model <- train %>% mutate(S = as.numeric(S), MS = as.numeric(MS)) %>%
      svm(formula = as.formula(
        paste(VAR, "~", paste(Ramfjord,collapse="+"), collapse= "")),data= .)
    pred_value <- predict(model, type="response", newdata=test)
    flag_fixed <- FALSE
  } else if(method == "SVM (Full Mouth)"){
    index <- which(names(train) %in% Full_mouth)
    for(i in index) {train[[i]] <- replace_na(train[[i]], 0); test[[i]] <- replace_na(test[[i]], 0)}
    model <- train %>% mutate(S = as.numeric(S), MS = as.numeric(MS)) %>% 
      svm(formula = as.formula(
            paste(VAR, "~", paste(Full_mouth,collapse="+"), collapse= "")),data= .)
    pred_value <- predict(model, type="response", newdata=test)
    flag_fixed <- FALSE
  }
  
  # metric = c("Prevalence", "AUC", "Sensitivity", "Specificity", "F1-score", 
  #                            "Diagnostic Odds Ratio")
  
  if(flag_fixed){
    temp <- table(predictions = pred_value, true = true_value)
    TN = temp[1,1]
    FP = temp[2,1]
    TP = temp[2,2]
    FN = temp[1,2]
  } else if(!flag_fixed){
    for(threshold in 0:100){
      pred_value_temp <- as.numeric(pred_value >= threshold/100)
      temp <- table(predictions = pred_value_temp, true = true_value)
      TN = temp[1,1]
      FP = temp[2,1]
      TP = temp[2,2]
      FN = temp[1,2]
      Specificity = TN/(TN+FP)
      if(Specificity >= 0.95) break
    }
  }
  
  metrics = c("Prevalence", "AUC", "Sensitivity", "Specificity", "F1-score", "Diagnostic Odds Ratio")
  metric = rep(NA, length=length(metrics))
  names(metric) <- metrics
  metric["Prevalence"] <- (TP+FP)/(TP+TN+FP+FN)
  metric["Sensitivity"] <- TP/(TP+FN)
  metric["Specificity"] <- TN/(TN+FP)
  metric["F1-score"] <- 2*TP/(2*TP+FP+FN)
  metric["Diagnostic Odds Ratio"] <- (TP/FN)/(FP/TN)
  if(flag_fixed) metric["AUC"] <- NA else if(!flag_fixed){
    perf <- prediction(predictions = pred_value, labels = true_value) %>% performance(., "auc")
    metric["AUC"] <- perf@y.values[[1]]
  }
  return(metric)
}

#color map:
COLORS = c(hsv(h=336/360, s = 1, v = 0.85), hsv(h=189/360, s = 1, v = 0.85),
           hsv(h=336/360, s = 1, v = 0.5), hsv(h=189/360, s = 1, v = 0.5),
           hsv(h=336/360, s = 1, v = 0.2), hsv(h=189/360, s = 1, v = 0.2))
```

# Data input part:

This part seems to generate a test set and train set. Values such as `perio_NHANES.csv`, `data`, `temp1`, `Q4.G` are missing. This part appear not to hinder the following analysis.

Definition of covariatesï¼š

-   ohq835: integer, Do you think you might have gum disease?
-   ohq850: integer, Ever had treatment for gum disease?
-   ohq855: integer, Any teeth became loose without an injury
-   ohq860: integer, Ever been told of bone loss around teeth
-   smk_stt: bollean, derived from `smq020` and `smq 040`
    -   If `SMQ020` AND `SMQ040` are both positive then YES, if else NO.
    -   `smq020`: {1,2,NA} "Smoked at least 100 cigarettes in life"
    -   `smq040`: {1,2,3,NA} "Do you now smoke cigarettes"

Datasets:

-   `DATA`: dental health examination data
-   `demo`: demographic data
-   `Q4` and `Q5`: four question variables and `smk_stt`
-   `data`: metged dataset

Case definition in the original dataset:

-   Create the periodontal disease classification variable `sp`
-   Separate variables into probing and attachment measures
-   Input:
    -   the dataset includes No. 02-31 teeth and each tooth has `la` and `pc` measurements.
    -   NAs were consider **negative**
-   Outcomes:
    -   `d$ps`: indicator for periodontal disease, values "mild", "mod", "sev"
    -   `d$S`: indicator for *severe* periodontal disease, values TRUE/FALSE
    -   `d$MS`: indicator for *moderate* to *severe* periodontal diseases, values TRUE/FALSE

```{r input and pre-process}
DATA <- read.csv("perio_NHANES.csv")
demo <- read.csv("nhanes_demo.csv")
temp1 <- merge(DATA, demo, all=F, by.x="seqn", by.y= "SEQN")

covariates <- c("seqn", "ohq835", "ohq850", "ohq855", "ohq860")

try.F <- sasxport.get("OHQ_F.xpt")
Q4.F <- try.F[,c("seqn", "ohq835", "ohq850", "ohq855", "ohq860")]
try.G <- sasxport.get("OHQ_G.xpt")
Q4.G <- try.G[,c("seqn", "ohq835", "ohq850", "ohq855", "ohq860")]
# Q4 <- bind_rows(Q4.F,Q4.G)
Q4 <- bind_rows(Q4.F,Q4.G) %>%
  filter(!is.na(ohq835) & !is.na(ohq850) & !is.na(ohq855) & !is.na(ohq860))

SMK.F <- sasxport.get("SMQ_F.XPT")
SMK.G <- sasxport.get("SMQ_G.XPT")
# SMK.H <- sasxport.get("SMQ_H.XPT")
bind_rows(
  SMK.F %>% select(seqn, smq020, smq040) %>% mutate(source = "F"),
  SMK.G %>% select(seqn, smq020, smq040) %>% mutate(source = "G")
) %>% mutate(smk_stt = !(is.na(smq020) | is.na(smq040))) %>%
  select(seqn, smk_stt, source) -> SMK

Q5 <- inner_join(Q4, SMK, by = "seqn")
data <- merge(temp1, Q5, by.x = "seqn", by.y = "seqn", all = FALSE) 

teeth <- data %>% select( starts_with("ohx") | starts_with("seqn")) %>%
  pivot_longer(cols = starts_with("ohx"),
               names_to = "tooth_id",
               values_to = "value") %>%
  mutate(tooth = str_extract(tooth_id, "\\d\\d"),
         test = str_extract(tooth_id, "pc|la"),
         site = str_extract(tooth_id, "[d|s|p|a]$"))
num_missing_tooth <- teeth %>% 
  group_by(seqn, tooth, test) %>% 
  summarise(NA_num = NA_num(value)) %>%
  ungroup() %>%
  filter(NA_num == 4) %>% 
  group_by(seqn, test) %>%
  summarise(num_missing_tooth = n()) %>%
  ungroup() %>% 
  filter(test == "la") %>% select(-test)#num_missing_tooth.la == num_missing_tooth.pc
num_missing_sites <- teeth %>% 
  group_by(seqn, test) %>% 
  summarise(num_missing_sites = NA_num(value)) %>%
  ungroup() %>%
  filter(test == "la") %>% select(-test)

data <- data %>% 
  left_join(x = ., y = num_missing_tooth, by = "seqn") %>%
  replace_na(list(num_missing_tooth = 0)) %>%
  left_join(x = ., y = num_missing_sites, by = "seqn")
d_orgin <- data %>% case_definition
  
dput(data, file = "HPC//100%_sample.d")

if(RECYCLE) rm(list = c("teeth"))
```

# Descriptive statistics

- CONSORT diagram
- number of subjects with different number of missing tooth

```{r consort}
study_cohorts <- 
  DATA %>%
  cohort_start("Participants in the Oral Health Examination project") %>%
  # Define cohorts using named expressions --------------------
  # Notice that you can use previously defined cohorts in subsequent steps
  cohort_define(
    with_demo = .full %>% filter(seqn %in% demo$SEQN),
    with_demo_Q5 = with_demo %>% filter(seqn %in% data$seqn),
    cohort_F = with_demo_Q5 %>% filter(seqn %in% SMK.F$seqn),
    cohort_G = with_demo_Q5 %>% filter(seqn %in% SMK.G$seqn),
    # anti_join is useful for counting exclusions -------------
    excluded_with_demo = anti_join(.full, with_demo, by = "seqn"),
    excluded_with_demo_Q5 = anti_join(with_demo, with_demo_Q5, by = "seqn")
  ) %>%
  # Provide text labels for cohorts ---------------------------
  cohort_label(
    with_demo = "Demographic data available",
    with_demo_Q5 = "Demographic and behavioral data available",
    cohort_F = "Cohort F, the training set",
    cohort_G = "Cohort G, the test set",
    excluded_with_demo = "Demographic data unavailable",
    excluded_with_demo_Q5 = "Behavioral data unavailable"
  )

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)) %>%
  consort_box_add(
    "excluded_with_demo", 1, 45, cohort_count_adorn(study_cohorts, excluded_with_demo)) %>%
  consort_box_add(
    "with_demo", 0, 40, cohort_count_adorn(study_cohorts, with_demo)) %>%
  consort_box_add(
    "excluded_with_demo_Q5", 1, 35, cohort_count_adorn(study_cohorts, excluded_with_demo_Q5)) %>%
  consort_box_add(
    "with_demo_Q5", 0, 30, cohort_count_adorn(study_cohorts, with_demo_Q5)) %>%
  # consort_box_add(
  #   "cohort_F", -30, 35, cohort_count_adorn(study_cohorts, cohort_F)) %>%
  # consort_box_add(
  #   "cohort_G", 30, 35, cohort_count_adorn(study_cohorts, cohort_G)) %>%
  consort_arrow_add(end = "excluded_with_demo", end_side = "left", start_x = 0, start_y = 45) %>%
  consort_arrow_add("full", "bottom", "with_demo", "top") %>%
  consort_arrow_add("with_demo", "bottom", "with_demo_Q5", "top") %>%
  consort_arrow_add(end = "excluded_with_demo_Q5", end_side = "left", start_x = 0, start_y = 35) %>%
  # consort_arrow_add(end = "excluded_with_demo_Q5", end_side = "left", start_x = 0, start_y = 45) %>%
  consort_arrow_add("full", "bottom", "with_demo_Q5", "top") #%>%
  # consort_arrow_add("with_demo_Q5", "bottom", "cohort_F", "top") %>%
  # consort_arrow_add("with_demo_Q5", "bottom", "cohort_G", "top")

fig.temp <- study_consort %>%
  ggplot() + 
  geom_consort() + xlim(-1, 2) + ylim(30, 50) + 
  theme_consort(margin_h = 4, margin_v = 2) #+
  # # you can include other ggplot geoms, as needed -------------
  # ggtext::geom_richtext(
  #   aes(x = 0, y = 10, label = "Allocation"),
  #   fill = "#9bc0fc"
  # )
fig.temp
ggsave("Manuscript//figures//CONSORT.jpeg", fig.temp, 
       width = FIG.WIDTH, height = 0.5*FIG.WIDTH, dpi = 1000)
if(RECYCLE) rm(list = c("Q4", "Q5", "temp1", "DATA", "demo", "fig.temp", "Q4.F", "Q4.G",
                        "SMK", "SMK.F", "SMK.G", "study_cohorts", "try.F","try.G", "study_consort"))
```

```{r subjects by missing tooth}
#Number of subjects and the number of missing teeth
d_orgin %>% 
  mutate(num.miss.tooth.level = cut(num_missing_tooth, 
                                    breaks = c(-Inf, 0.1, 5.1, 10.1, 15.1, Inf),
                                    labels = c("No missing","Missing <= 5",
                                               "5 < Missing <= 10", 
                                               "10 < Missing <= 15",
                                               "Missing > 15"))) %>%
  count(num.miss.tooth.level) %>% 
  mutate(Count = paste(n, " (", round(n/sum(n)*100, digits = 1), "%)", sep = "")) %>%
  rename(`Number of Missing Teeth` = num.miss.tooth.level) %>%
  select(`Number of Missing Teeth`, `Count`) %>%
  kbl() %>%
  kable_classic(full_width = F, html_font = "Cambria") -> tbl.temp
tbl.temp
save_kable(tbl.temp, file = "Manuscript//figures//number_missing_teeth.jpeg", 
           density = 1000, zoom = 2.5)
```
# Coefficients for Imputation Models

```{r imputation coefs}
temp <- d_orgin %>% 
  filter(num_missing_tooth <= 10) %>%
  mutate(mean_PC = 
           (select(., ends_with(c("pcd", "pcs", "pcp", "pca"))) %>%
              rowMeans(x = ., na.rm = TRUE)
            ),
         mean_CAL = 
           (select(., ends_with(c("lad", "las", "lap", "laa"))) %>%
              rowMeans(x = ., na.rm = TRUE)
            )
         )
tempfun <- function(x) return(x$coefficients)
lm(mean_PC ~ age+sex+race+
             ohq835+ohq850+ohq855+ohq860+
             smk_stt+
             num_missing_tooth, 
   data = temp) %>% summary() %>% tempfun() %>%
  kbl(digits = 4) %>% kable_classic(full_width = F, html_font = "Cambria")
lm(mean_CAL ~ age+sex+race+
             ohq835+ohq850+ohq855+ohq860+
             smk_stt+
             num_missing_tooth, 
   data = temp) %>% summary() %>% tempfun() %>%
  kbl(digits = 4) %>% kable_classic(full_width = F, html_font = "Cambria")
glm(MS ~ age+sex+race+
             ohq835+ohq850+ohq855+ohq860+
             smk_stt+
             num_missing_tooth, 
   data = temp, family = "binomial") %>% 
  summary() %>% tempfun() %>%
  kbl(digits = 4) %>% kable_classic(full_width = F, html_font = "Cambria")
glm(S ~ age+sex+race+
             ohq835+ohq850+ohq855+ohq860+
             smk_stt+
             num_missing_tooth, 
   data = temp, family = "binomial") %>% 
  summary() %>% tempfun() %>%
  kbl(digits = 4) %>% kable_classic(full_width = F, html_font = "Cambria")
```


# Missing values imputed with MICE, on MSI, not run

-   variables used as MACRO:
    -   `N.CORE`, `N.IMP.CORE`, `NUM`: number of cores, imputation per core and imputed datasets
    -   `MAXITER`: maximum number of iteration in MICE
    -   `DATE`: today's date. Automatically generated.
    -   `MICE_METH`: methods used in MICE, such as "pmm" and "cart". Looped according to the variable `mice_meth`.
    -   `MICE_MODEL`: a character combination of "OHX" (dental health measurement), "demo" (demographic data), "Q4" (the four questions in dental health questionnaire), "smk" (smoking status), "numtooth" (number of missing tooth). Looped according to the variable `mice_model`
    -   `MODEL_FULL`: Automatically calculated using MICE_MODEL.

```{r create scripts for MSI 1, eval=TRUE}
### create R scripts
mice_meth = c("pmm", "cart", "rf")
mice_model = c("OHX", "OHX_demo", "OHX_demo_Q4", 
               "OHX_demo_Q4_numtooth", "OHX_demo_Q4_smk", 
               "OHX_demo_Q4_smk_numtooth")
N.CORE = 5 %>% as.character()
N.IMP.CORE = 2 %>% as.character()
NUM = (as.numeric(N.CORE)*as.numeric(N.IMP.CORE)) %>% as.character()
MAXITER = 50 %>% as.character()
DATE = paste(substr(Sys.Date(), 6, 7), substr(Sys.Date(), 9, 10), sep = "") %>% as.character()

model_full <- function(MICE_MODEL){
  MODEL_FULL = ""
  if(str_detect(MICE_MODEL, "OHX"))
    MODEL_FULL = paste(MODEL_FULL, "starts_with('ohx')", sep = ", ")
  if(str_detect(MICE_MODEL, "demo"))
    MODEL_FULL = paste(MODEL_FULL, "age", "sex", "race", sep = ", ")
  if(str_detect(MICE_MODEL, "Q4"))
    MODEL_FULL = paste(MODEL_FULL, "starts_with('ohq')", sep = ", ")
  if(str_detect(MICE_MODEL, "numtooth"))
    MODEL_FULL = paste(MODEL_FULL, "num_missing_tooth", sep = ", ")
  if(str_detect(MICE_MODEL, "smk"))
    MODEL_FULL = paste(MODEL_FULL, "smk_stt", sep = ", ")
  MODEL_FULL
}
```

```{r create scripts for MSI 2, eval=FALSE, echo=TRUE}
# mice_meth = "rf"
# N.CORE = 10 %>% as.character()
# N.IMP.CORE = 1 %>% as.character()
#capitalized variable for MACRO use: NUM, MAXITER, DATE, MICE_METH, MICE_MODEL, MODEL_FULL
Rscript <- "library(tidyverse)
d <- dget(file='/home/guanwh/zhan7474/dental_micro/100%_sample.d')
d_imp <- d %>% select(MODEL_FULL)
ID <- d %>% select(all_of(setdiff(names(d), names(d_imp))))
temp_d <- mice::parlmice(data = d_imp, maxit = MAXITER, 
                     cluster.seed = 123456, n.core = N.CORE, n.imp.core = N.IMP.CORE,
                     cl.type = 'FORK', meth = 'MICE_METH', printFlag = FALSE)
for(i in 1:NUM){
	d <- bind_cols(ID, complete(temp_d, i))
	dput(d, paste('/home/guanwh/zhan7474/dental_micro/d_miced_MICE_METH_MICE_MODEL_', i, '.d', sep = ''))
}
save.image('/home/guanwh/zhan7474/dental_micro/micing_MICE_METH_MICE_MODEL_DATE.RData')"
Rscript_file <- "HPC//micing_MICE_METH_MICE_MODEL_DATE.R"
for(MICE_METH in mice_meth)
    for(MICE_MODEL in mice_model){
      Rscript_specified <- Rscript %>% 
        str_replace_all(pattern = "NUM", NUM) %>%
        str_replace_all(pattern = "MAXITER", MAXITER) %>%
        str_replace_all(pattern = "DATE", DATE) %>%
        str_replace_all(pattern = "MICE_METH", MICE_METH) %>%
        str_replace_all(pattern = "MICE_MODEL", MICE_MODEL) %>%
        str_replace_all(pattern = "MODEL_FULL", model_full(MICE_MODEL)) %>%
        str_replace_all(pattern = "N.CORE", N.CORE) %>%
        str_replace_all(pattern = "N.IMP.CORE", N.IMP.CORE)
      Rscript_file_specified <- Rscript_file %>% 
        str_replace_all(pattern = "MICE_METH", MICE_METH) %>%
        str_replace_all(pattern = "DATE", DATE) %>%
        str_replace_all(pattern = "MICE_MODEL", MICE_MODEL)
      cat(Rscript_specified, file = Rscript_file_specified)
    }

### create shell files
SH <- "#!/bin/bash
#SBATCH --job-name=miceII
#SBATCH -o /home/guanwh/zhan7474/dental_micro/micing_MICE_METH_MICE_MODEL_DATE.out
#SBATCH -e /home/guanwh/zhan7474/dental_micro/micing_MICE_METH_MICE_MODEL_DATE.err
#SBATCH -p msismall
#SBATCH -c N.CORE
#SBATCH --mem-per-cpu=1000
#SBATCH -t 48:00:00

module load R
Rscript /home/guanwh/zhan7474/dental_micro/micing_MICE_METH_MICE_MODEL_DATE.R"
SH_file <- "HPC//micing_MICE_METH_MICE_MODEL_DATE.sh"
II = 1
for(MICE_METH in mice_meth)
    for(MICE_MODEL in mice_model){
      SH_specified <- SH %>% 
        str_replace_all(pattern = "II", as.character(II)) %>%
        str_replace_all(pattern = "DATE", DATE) %>%
        str_replace_all(pattern = "MICE_METH", MICE_METH) %>%
        str_replace_all(pattern = "MICE_MODEL", MICE_MODEL) %>%
        str_replace_all(pattern = "N.CORE", N.CORE)
      SH_file_specified <- SH_file %>% 
        str_replace_all(pattern = "MICE_METH", MICE_METH) %>%
        str_replace_all(pattern = "DATE", DATE) %>%
        str_replace_all(pattern = "MICE_MODEL", MICE_MODEL)
      cat(SH_specified, file = SH_file_specified)
      II = II+1
    }
rm(list= c("II"))

### put files to the HPC MANUALLY
#sesstion <- ssh::ssh_connect("zhan7474@agate.msi.umn.edu", verbose = TRUE)
script <- "dos2unix /home/guanwh/zhan7474/dental_micro/micing_MICE_METH_MICE_MODEL_DATE.sh
sbatch /home/guanwh/zhan7474/dental_micro/micing_MICE_METH_MICE_MODEL_DATE.sh\n"
cat(" ", file = paste("HPC//script",DATE,".txt", sep = ""), append = FALSE)
for(MICE_METH in mice_meth) {
  for(MICE_MODEL in mice_model){
    script_specified <- script %>% 
      str_replace_all(pattern = "MICE_METH", MICE_METH) %>%
      str_replace_all(pattern = "DATE", DATE) %>%
      str_replace_all(pattern = "MICE_MODEL", MICE_MODEL)
    cat(script_specified, file = paste("HPC//script",DATE,".txt", sep = ""), 
        append = TRUE)
  }
}
```

# Importing imputed data and case defining:

-   Importing imputed data
-   Create the periodontal disease classification variable `sp`
-   Separate variables into probing and attachment measures
-   Input:
    -   the dataset includes No. 02-31 teeth and each tooth has `la` and `pc` measurements.
-   Outcomes:
    -   `d$ps`: indicator for periodontal disease, values "mild", "mod", "sev"
    -   `d$S`: indicator for *severe* periodontal disease, values TRUE/FALSE
    -   `d$MS`: indicator for *moderate* to *severe* periodontal diseases, values TRUE/FALSE

```{r case definition and import imputed data, cache=TRUE}
NUM <- as.numeric(NUM)
MICE_METH <- mice_meth
MICE_MODEL <- mice_model
file_path <- "HPC//d_miced_MICE_METH_MICE_MODEL_NUM.d"
file_paths <- file_path %>% 
  sapply(X = ., FUN = str_replace, simplify = TRUE, 
         pattern = "MICE_METH", replacement = MICE_METH) %>% c() %>%
  sapply(X = ., FUN = str_replace, simplify = TRUE, 
         pattern = "MICE_MODEL", replacement = MICE_MODEL) %>% c() %>%
  sapply(X = ., FUN = str_replace, simplify = TRUE, 
         pattern = "NUM", replacement = paste(1:NUM)) %>% c()

data_miced_list <- sapply(X = file_paths, FUN = dget, simplify = FALSE)

d_miced_list <- data_miced_list %>% lapply(., FUN = case_definition)
d_list <- append(d_miced_list, list("d_orgin" = d_orgin), after=0)
d_df <- d_list %>% 
  bind_rows(.id = "df") %>%
  mutate(source = str_extract(df, pattern = "(miced)|(orgin)")) %>%
  mutate(method = str_extract(df, pattern = 
                                paste(paste("(", MICE_METH, ")", 
                                            sep = ""), 
                                      collapse = "|"))
         ) %>%
  mutate(OHX = str_detect(df, "OHX"), DEMO = str_detect(df, "demo"),
         OHQ = str_detect(df, "Q4"),  SMK  = str_detect(df, "smk"),
         NUMTOOTH = str_detect(df, "numtooth"))

flag <- lapply(d_miced_list, FUN = pull, "seqn") %>% 
  lapply(., FUN = identical, d_orgin$seqn) %>% 
  unlist()
if(sum(!flag) > 0) {
  stop("seqn in d_miced_list not match d_orgin")
  knitr::knit_exit()
}

# train.d_miced_list <- d_miced_list %>% lapply(., FUN = dplyr::filter, source == "F")
# test.d_miced_list  <- d_miced_list %>% lapply(., FUN = dplyr::filter, source == "G")

# train.d_orgin <- data %>% filter(source == "F")
# test.d_orgin <- data %>% filter(source == "G")
```



# Comparison between different MICE models and methods

Models:

  -   OHX only
  -   OHX + covariates (OHQ, demo, smk_stt)
  -   OHX + covariates (OHQ, demo, smk_stt) + num_missing_tooth
  -   other models are also computed (not shown)

Methods:

  -   pmm
  -   cart
  
```{r, fig.width=10, fig.height=6}
# var = "S"
#all models and methods
# d_df %>%
#   group_by(df) %>% count(num_missing_tooth, !!as.name(var)) %>%
#   pivot_wider(names_from = !!as.name(var), values_from = n) %>%
#   mutate(df = str_remove_all(df, pattern = "(^HPC//d_)|(^d_)|(_\\d.d$)|(_\\d\\d.d$)")) %>%
#   replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
#   mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
#   mutate(sample_size = `FALSE` + `TRUE`) %>%
#   mutate(num_missing_tooth = as.factor(num_missing_tooth)) %>%
#   ggplot(aes(color = df, x = num_missing_tooth, y = prev), data = .) + 
#   geom_point(aes(size = sample_size), inherit.aes = TRUE,
#              data = . %>% filter(df == "orgin")) + 
#   geom_boxplot(inherit.aes = TRUE,
#                data = . %>% filter(df != "orgin")) + 
#   #geom_ma(ma_fun = SMA, n = 3)+
#   theme_bw() + 
#   xlab("Number of lost teeth") + 
#   ylab(ifelse(var == "S", "Prevelence of Severe cases", 
#               "Prevelence of Moderate and Severe cases")) +
#   guides(size=guide_legend(title="Number of participants")) 

tempfun <- function(var){
  #rely on the variables in the .Global
  #return a figure
  #only include pmm, cart and rf!!!!!
  d_df %>% 
    group_by(df) %>% count(num_missing_tooth, !!as.name(var)) %>%
    pivot_wider(names_from = !!as.name(var), values_from = n) %>%
    mutate(df = str_remove_all(df, pattern = "(^HPC//d_)|(^d_)|(_\\d.d$)|(_\\d\\d.d$)")) %>%
    filter(df %in% c("orgin", "miced_pmm_OHX", "miced_pmm_OHX_demo_Q4_smk", 
                     "miced_pmm_OHX_demo_Q4_smk_numtooth",
                     "miced_cart_OHX", "miced_cart_OHX_demo_Q4_smk", 
                     "miced_cart_OHX_demo_Q4_smk_numtooth")) %>%
    replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
    mutate(method = str_extract(df, "(pmm)|(cart)|(orgin)")) %>%
    mutate(method = if_else(method == "orgin", 
                            list(list("pmm", "cart")), 
                            sapply(method, as.list, simplify = FALSE))) %>%
    unnest_longer(col = method) %>%
    mutate(model = str_remove_all(df, pattern = "(miced_cart_)|(miced_pmm_)")) %>%
    mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
    mutate(sample_size = `FALSE` + `TRUE`) %>%
    mutate(num_missing_tooth = as.factor(num_missing_tooth)) %>%
    ggplot(aes(x = num_missing_tooth, y = prev), data = .) + 
    geom_point(aes(size = sample_size), inherit.aes = TRUE, color = COLORS[2],
               data = . %>% filter(df == "orgin")) + 
    scale_size(name = "Original Data:\nNumber of participants", 
               breaks = seq(250, 1500, by=250))+
    #guides(size=guide_legend(title="Original Data:\nNumber of participants"))+
    geom_boxplot(aes(fill = model), # ymax = max(prev), ymin = min(prev)
                 inherit.aes = TRUE, color = "grey70",
                 linewidth = 0.2, coef = 10, outlier.size = 0.5,
                 data = . %>% filter(df != "orgin")) + 
    scale_fill_manual(values = hsv(h=c(336-50, 336-25, 336)/360, s = 1, 
                                   v = c(0.55, 0.7, 0.85)),
                      name = "Imputed Data:\nMICE models",
                      labels = c("Only loss of attachment",
                                 " + Covariates", 
                                 " + Covariates + Number of lost teeth"))+
    facet_grid(.~method) + theme_bw() + 
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
    xlab("Number of lost teeth") + 
    ylab(ifelse(var == "S", "Prevelence of Severe cases", 
                "Prevelence of Moderate and Severe cases"))+
    ylim(0,ifelse(var == "MS", 1, NA))
}
fig_temp1 <- tempfun("MS")
fig_temp2 <- tempfun("S")
fig.temp <- lemon::grid_arrange_shared_legend(fig_temp1, fig_temp2, ncol=1,
                                              nrow=2, position = "bottom", plot = TRUE)
ggsave("Manuscript//figures//Prevelence_missing_models.jpeg", fig.temp, 
       width = FIG.WIDTH*1.5, height = 1*FIG.WIDTH, dpi = 1000)

tempfun2 <- function(var){
  #rely on the variables in the .Global
  #return a figure
  #only include pmm and cart!!!!!
  d_df %>% 
    mutate(age_grp = cut(age, seq(30, 80, by=5), include.lowest = TRUE)) %>%
    group_by(df) %>% count(age_grp, !!as.name(var)) %>%
    pivot_wider(names_from = !!as.name(var), values_from = n) %>%
    mutate(df = str_remove_all(df, pattern = "(^HPC//d_)|(^d_)|(_\\d.d$)|(_\\d\\d.d$)")) %>%
    filter(df %in% c("orgin", 
                     "miced_cart_OHX_demo_Q4_smk_numtooth")) %>%
    replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
    mutate(method = str_extract(df, "(pmm)|(cart)|(orgin)")) %>%
    # mutate(method = if_else(method == "orgin", 
    #                         list(list("pmm", "cart")), 
    #                         sapply(method, as.list, simplify = FALSE))) %>%
    # unnest_longer(col = method) %>%
    mutate(model = str_remove_all(df, pattern = "(miced_cart_)|(miced_pmm_)")) %>%
    mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
    mutate(sample_size = `FALSE` + `TRUE`) %>%
    ggplot(aes(x = age_grp, y = prev), data = .) + 
    geom_point(aes(size = sample_size), inherit.aes = TRUE, color = COLORS[2],
               data = . %>% filter(df == "orgin")) + 
    scale_size(name = "Original Data:\nNumber of participants", 
               breaks = seq(250, 1500, by=250))+
    #guides(size=guide_legend(title="Original Data:\nNumber of participants"))+
    geom_boxplot(aes(fill = model), # ymax = max(prev), ymin = min(prev)
                 inherit.aes = TRUE, color = "grey70",
                 linewidth = 0.5, coef = 10, outlier.size = 0.5,
                 data = . %>% filter(df != "orgin")) + 
    scale_fill_manual(values = COLORS[1],
                      name = "Imputed Data:\nMICE Method",
                      labels = c("CART"))+
    # facet_grid(method~.) + 
    theme_bw() + 
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
    xlab("Age Groups") + 
    ylab(ifelse(var == "S", "Prevelence of Severe cases", 
                "Prevelence of Moderate and Severe cases"))#+
    # ylim(0,1)
}
fig_temp1 <- tempfun2("MS")
fig_temp2 <- tempfun2("S")
fig_temp2
ggsave("Manuscript//figures//Prevelence_Severe_age.jpeg", fig_temp2, 
       width = FIG.WIDTH, height = 0.75*FIG.WIDTH, dpi = 1000)
fig.temp <- lemon::grid_arrange_shared_legend(fig_temp1, fig_temp2, 
                                              ncol=2, position = "right", plot = TRUE)
ggsave("Manuscript//figures//Prevelence_age.jpeg", fig.temp, 
       width = FIG.WIDTH*2, height = 0.75*FIG.WIDTH, dpi = 1000)


# d_orgin %>%
#   count(num_missing_tooth, S) %>%
#   pivot_wider(names_from = S, values_from = n) %>%
#   replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
#   mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
#   mutate(sample_size = `FALSE` + `TRUE`) %>%
#   qplot(data = ., x=num_missing_tooth, y=prev, size = sample_size,
#         xlab="Number of lost teeth",
#         ylab="Prevelence of [S]evere cases") + theme_bw() + 
#   guides(size=guide_legend(title="Number of participants"))-> fig.temp1
# 
# 
# 
# d_orgin %>%
#   count(num_missing_tooth, MS) %>%
#   pivot_wider(names_from = MS, values_from = n) %>%
#   replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
#   mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
#   mutate(sample_size = `FALSE` + `TRUE`) %>%
#   qplot(data = ., x=num_missing_tooth, y=prev, size = sample_size,
#         xlab="Number of lost teeth",
#         ylab="Prevelence of [M]oderate and [S]evere cases") + theme_bw() + 
#   guides(size=guide_legend(title="Number of participants"))-> fig.temp2
# fig.temp <- gridExtra::grid.arrange(fig.temp1, fig.temp2, ncol=2)
# ggsave("Manuscript//figures//Prevelence_missing_ori.jpeg", fig.temp, 
#        width = FIG.WIDTH*2, height = 0.75*FIG.WIDTH, dpi = 1000)
# 
# d_miced %>%
#   count(num_missing_tooth, S) %>%
#   pivot_wider(names_from = S, values_from = n) %>%
#   replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
#   mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
#   mutate(sample_size = `FALSE` + `TRUE`) %>%
#   qplot(data = ., x=num_missing_tooth, y=prev, size = sample_size,
#         xlab="Number of lost teeth",
#         ylab="Prevelence of [S]evere cases") + theme_bw() + 
#   guides(size=guide_legend(title="Number of participants")) -> fig.temp1
# ggsave("Manuscript//figures//Prevelence_S_missing.jpeg", fig.temp, 
#        width = FIG.WIDTH, height = 0.75*FIG.WIDTH, dpi = 1000)
# 
# d_miced %>%
#   count(num_missing_tooth, MS) %>%
#   pivot_wider(names_from = MS, values_from = n) %>%
#   replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
#   mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
#   mutate(sample_size = `FALSE` + `TRUE`) %>%
#   qplot(data = ., x=num_missing_tooth, y=prev, size = sample_size,
#         xlab="Number of lost teeth",
#         ylab="Prevelence of [M]oderate and [S]evere cases") + theme_bw() + 
#   guides(size=guide_legend(title="Number of participants"))-> fig.temp2
# fig.temp <- gridExtra::grid.arrange(fig.temp1, fig.temp2, ncol=2)
# ggsave("Manuscript//figures//Prevelence_missing.jpeg", fig.temp, 
#        width = FIG.WIDTH*2, height = 0.75*FIG.WIDTH, dpi = 1000)
```


# Comparing case definitions between MICEd dataset and oringinal dataset


```{r}
tempfun <- function(d){
  #this function returns a summary table (kable) of ps, MS and S
  summary(d[,c("ps","MS","S")]) %>%
    kbl(caption = "Number of periodontal diseases in the MICEd dataset") %>%
    kable_classic(full_width = F, html_font = "Cambria")
}

tempfun2 <- function(d_orgin, d_miced){
  #compare frequecies between miced and original dataset
  #only input a single data frame
  #return a comparison table with original definition in columns
  d_miced_ps <- d_miced %>% select(seqn, ps) 
  d_orgin_ps <- d_orgin %>% select(seqn, ps) 
  
  comparison <- full_join(d_miced_ps, d_orgin_ps, by = "seqn")
  comparison$ps.x <- factor(comparison$ps.x, 
                            levels = c("no", "mild","mod","sev"))
  comparison$ps.y <- factor(comparison$ps.y, 
                            levels = c("no", "mild","mod","sev"))
  comparison_tbl <- with(comparison,table(ps.y, ps.x))
  comparison_tbl <- cbind(comparison_tbl, "Original" = rowSums(comparison_tbl))
  comparison_tbl <- rbind(comparison_tbl, "Imputed" = colSums(comparison_tbl))
  return(comparison_tbl)
}

models = str_replace("HPC//d_miced_cart_OHX_demo_Q4_numtooth_NUM.d",
                     "NUM", as.character(1:10))
temp <- array(data = NA, dim = c(5,5,length(models)), 
              dimnames = list(c("no", "mild","mod","sev", "Imputed"),
                              c("no", "mild","mod","sev", "Original"),
                              NULL))
for(i in 1:length(models)){
  temp[ , ,i] <- tempfun2(d_orgin = d_orgin, 
                          d_miced = d_list[[models[i]]])
}
comparison_mean <- round(apply(temp, MARGIN = c(1,2), FUN = mean))
comparison_sd <- round(apply(temp, MARGIN = c(1,2), FUN = sd))
comparison_tbl <- matrix(paste(c(comparison_mean), 
                               if_else(c(comparison_sd) == 0, "",
                                       paste(" \U00B1 ", c(comparison_sd), sep = "")),
                               sep = ""),
                    nrow = 5, ncol=5, byrow = FALSE)
comparison_tbl[, 5] <- paste(comparison_tbl[, 5], " (",
                             round(comparison_mean[,5]/comparison_mean[5,5]*100, 
                                   digits = 1),
                             "%)", sep ="")
comparison_tbl[5, 1:4] <- paste(comparison_tbl[5, 1:4], "\n(",
                             round(comparison_mean[5, 1:4]/comparison_mean[5,5]*100, 
                                   digits = 1), " \U00B1 ",
                             round(comparison_sd[5, 1:4]  /comparison_mean[5,5]*100, 
                                   digits = 1), "%)", 
                             sep ="")
colnames(comparison_tbl) <- c("Healthy", "Mild", "Moderate", "Severe", "Total cases (original)")
rownames(comparison_tbl) <- c("Healthy", "Mild", "Moderate", "Severe", "Total cases (imputed)")

tbl.temp <- comparison_tbl%>% 
  kbl("html", escape = F) %>%
  kable_classic(full_width = F, html_font = "Cambria") 
tbl.temp
save_kable(tbl.temp, file = "Manuscript//figures//Case_Definition_comparison.jpeg", 
           density = 1000, zoom = 2.5)

```


# Distribution of dental measurements of Ramfjord teeth pre- and post-imputation

Using "cart" method and OHX+covariates+num.missing.tooth model. 

```{r, fig.width=10, fig.height=6}
Ramfjord <- names(d_orgin) %>% str_subset(pattern = "^ohx(03)|(09)|(12)|(19)|(25)|(28)")
Full_mouth <- names(d_orgin) %>% str_subset(pattern = "^ohx")

temp_fun <- function(d){
  #count the number of specific LA/PC measurements at Ramfjord teeth
  d <- d %>% select(all_of(Ramfjord)) %>% #the order of select = the order of Ramfjord
    apply(MARGIN = 2, FUN = table, useNA = "no") %>% bind_rows() %>% 
    as.matrix() %>% reshape2::melt(value.name = "Count", na.rm = FALSE) %>% 
    as_tibble() %>% 
    rename(Value = "Var2", Teeth = "Var1") %>%
    mutate(Teeth = rep(Ramfjord, max(Value)+1)) %>%
    mutate(tooth = str_extract(Teeth, "\\d\\d"),
           test = str_extract(Teeth, "pc|la"),
           site = str_extract(Teeth, "[d|s|p|a]$")) %>%
    mutate(Count = replace_na(Count, 0))
  return(d)
}

models = str_replace("HPC//d_miced_cart_OHX_demo_Q4_numtooth_NUM.d",
                     "NUM", as.character(1:10))
temp_orgin <- d_list[["d_orgin"]] %>% temp_fun()
temp_miced <- d_list[models] %>% 
  lapply(., FUN = temp_fun) %>%
  lapply(., FUN = function(d) return(d$Count - temp_orgin$Count)) %>%
  as.data.frame() %>% 
  mutate(Recovered = apply(., MARGIN = 1, FUN = mean),
         SD = apply(., MARGIN = 1, FUN = sd)) %>%
  select(Recovered, SD) %>%
  cbind(temp_orgin, .) %>%
  as_tibble() %>%
  rename(Observed = "Count")

measurement = "la"
temp <- temp_miced %>%
  filter(test == measurement) %>% 
  pivot_longer(cols = c("Observed", "Recovered"), 
               names_to = "Type", values_to = "Count") %>%
  mutate(SD = if_else(Type == "Observed", true = NA_real_, false = SD))
temp2 <- temp %>% group_by(Teeth, Value) %>%
  dplyr::summarise(tooth = unique(tooth), test = unique(test), site = unique(site),
                   SD = sum(SD, na.rm = TRUE), Count = sum(Count)) %>%
  ungroup()
fig.temp <- temp %>%
  ggplot(aes(x= Value, y = Count, 
             fill = factor(Type, levels=c("Recovered", "Observed")))) + 
  geom_bar(stat="identity", position = "stack") + facet_grid(site~tooth) +
  geom_errorbar(mapping = aes(ymin = Count-SD, ymax = Count+SD, x = Value), width=0.8,
                position=position_dodge(.9), data = temp2, inherit.aes = FALSE, 
                color = "black", linewidth = 0.1)+
  labs(fill = "Type") + scale_fill_manual(values = COLORS[c(1,2)]) +
  theme_bw()
fig.temp
ggsave(paste("Manuscript//figures//Recovered ", measurement, ".jpeg", sep = ""), 
       fig.temp, width = FIG.WIDTH*1, height = 0.625*FIG.WIDTH, dpi = 1000)

measurement = "pc"
temp <- temp_miced %>%
  filter(test == measurement) %>% 
  pivot_longer(cols = c("Observed", "Recovered"), 
               names_to = "Type", values_to = "Count") %>%
  mutate(SD = if_else(Type == "Observed", true = NA_real_, false = SD))
temp2 <- temp %>% group_by(Teeth, Value) %>%
  dplyr::summarise(tooth = unique(tooth), test = unique(test), site = unique(site),
                   SD = sum(SD, na.rm = TRUE), Count = sum(Count)) %>%
  ungroup()
fig.temp <- temp %>%
  ggplot(aes(x= Value, y = Count, 
             fill = factor(Type, levels=c("Recovered", "Observed")))) + 
  geom_bar(stat="identity", position = "stack") + facet_grid(site~tooth) +
  geom_errorbar(mapping = aes(ymin = Count-SD, ymax = Count+SD, x = Value), width=0.8,
                position=position_dodge(.9), data = temp2, inherit.aes = FALSE, 
                color = "black", linewidth = 0.1)+
  labs(fill = "Type") + scale_fill_manual(values = COLORS[c(1,2)]) +
  theme_bw()
fig.temp
ggsave(paste("Manuscript//figures//Recovered ", measurement, ".jpeg", sep = ""), 
       fig.temp, width = FIG.WIDTH*1, height = 0.625*FIG.WIDTH, dpi = 1000)

if(RECYCLE) 
  rm(list = c("temp_orgin", "temp_miced", "temp_fun"))
```

# Model Validation using ATT of smk_stt

-   Using `smk_stt` as the covariate to establish the validity of missing data imputation.
-   Using propensity score matching method.
    -   propensity score model: $$logit(SMK) = \beta_0 + \beta_1 AGE + \beta_2 SEX + \beta_3 RACE_{BLACK} + \beta_4 RACE_{HISPANIC} + \beta_5 RACE_{OTHER}$$
-   If the method is valid, we expect to have a higher average causal treatment effect among the treated (ATT) (a higher risk of prondental disease) among those who smoke, especially when $ATT = 0$ in the original dataset.

```{r, fig.width=10, fig.height=6}
#Propensity models using age, sex, race as the covariates
#smk_stt is not balanced between sex and race
tabUnmatched <- tableone::CreateTableOne(strata = "smk_stt", data = d_orgin, 
                                         vars = c("age","sex","race"),test = FALSE)
tableone::kableone(tabUnmatched, smd = TRUE) %>%
  kable_classic(full_width = F, html_font = "Cambria") 

tempfun2 <- function(d, var = "S"){
  #calculate the ATT of smk_stt on prodentitist using propensity score matching
  #within approach: do the PS matching in each imputed dataset
  rownames(d) <- 1:nrow(d)
  d <- d %>% mutate(sex = as.factor(sex), race = as.factor(race))
  mod_match <- MatchIt::matchit(smk_stt ~ age + sex + race,
                                data = d, ratio = 1, replace = TRUE)
  match_index <- as.numeric(mod_match$match.matrix)
  # d_match <- data.frame(
  #   rbind(d[d$smk_stt == TRUE, ],
  #         d[as.numeric(mod_match$match.matrix), ]))
  # tabmatched <- tableone::CreateTableOne(strata = "smk_stt", data = d_match, 
  #                                        vars = c("age","sex","race"),test = FALSE)
  # tableone::kableone(tabmatched, smd = TRUE)
  
  d_var <- dplyr::pull(d, var)
  x1 <- sum(d_var[d$smk_stt == TRUE])
  x0 <- sum(d_var[match_index])

  n1 <- sum(d$smk_stt == TRUE)
  n0 <- length(match_index)
  p1 <- x1/n1
  p0 <- x0/n0
  RR <- p1/p0
  CI_RR <- exp(log(RR) + c(-1, 1)*qnorm(0.975)*sqrt(1/x1 + 1/x0 - 1/n1 - 1/n0))
  ATT <- p1 -  p0
  SE_ATT <- sqrt(p1*(1-p1)/n1 + p0*(1-p0)/n0)
  CI_ATT <- p1 - p0 + c(-1, 1)*qnorm(0.975)*SE_ATT
  return(list(ATT = ATT, CI = CI_ATT, p1=p1, p0=p0, N = n1, RR = RR, CI_RR = CI_RR, N0= n0))
}

tempfun3 <- function(seg, d, var = "S"){
  #this function calculate ATT/the aesthetics required for one dataset
  x = seg[1]
  xend = seg[2]
  d.seg <- d %>% dplyr::filter(num_missing_tooth >= x & num_missing_tooth < xend)
  d.seg.ATT <- tempfun2(d.seg, var = var)
  result <- data.frame(x=rep(x,2), xend=rep(xend,2), 
                       y=c(d.seg.ATT$p0, d.seg.ATT$p1),
                       yend=c(d.seg.ATT$p0, d.seg.ATT$p1),
                       trt = c("Non-Smokers", "Smokers"),
                       RR = c(NA_character_, 
                              paste(round(d.seg.ATT$RR, digits = 2), " (",
                                    paste(round(d.seg.ATT$CI_RR,digits = 2), collapse = ", "),
                                    ")", sep = "")),
                       Nt = c(d.seg.ATT$N0, d.seg.ATT$N)
                       #Nt = c(NA_character_, as.character(d.seg.ATT$N))
                       )
  return(result)
}

tempfun4 <- function(d_list, var = "S", typical = 1, 
                     segment = data.frame(x = c(0, 0.8, 14.8), 
                                          xend = c(0.2, 14.2, 28.2))
                     ){
  #this function calculate ATT/the aesthetics required for all datasets
  d_list_ATT <- lapply(d_list, 
                       FUN = function(x) apply(segment, MARGIN = 1, 
                                               FUN = tempfun3, d = x, var = var) ) %>%
    lapply(., bind_rows) %>%
    bind_rows(.id = "df")
  d_list_ATT %>% 
    mutate(source = str_extract(df, pattern = "(miced)|(orgin)"),
           typical = str_detect(df, pattern = paste("(orgin)|", typical, sep=""))) %>%
    mutate(typical = as.factor(typical)) #%>%
    #filter(source != "miced" | xend > 0.001)
}

tempfun5 <- function(d, var = "S"){
  #this function calculate prevalence/the aesthetics required for one dataset
  d_prev <- d %>%
    count(num_missing_tooth, !!as.name(var)) %>%
    pivot_wider(names_from = !!as.name(var), values_from = n) %>%
    replace_na(list(`FALSE` = 0, `TRUE` = 0)) %>%
    mutate(prev = `TRUE`/(`FALSE` + `TRUE`)) %>%
    mutate(sample_size = `FALSE` + `TRUE`)
  return(d_prev)
}
tempfun6 <- function(d_list, var = "S", typical = 1){
  #this function calculate prevalence/the aesthetics required for all datasets
  d_list %>% lapply(., FUN = tempfun5, var = var) %>%
    bind_rows(.id = "df") %>%
    mutate(source = str_extract(df, pattern = "(miced)|(orgin)"),
           typical = str_detect(df, pattern = paste("(orgin)|", typical, sep=""))) %>%
    mutate(typical = as.factor(typical))
}


tempfun7 <- function(var, TYPICAL, d_list){
  #just a wrapper function to plot the ATT figure
  #return a figure
  #for tempfun2-6, it's OK to process multiple miced datasets 
  #because the results are not pooled, but in this function
  #miced data are averaged!!
  d_list_ATT <- d_list %>% 
    tempfun4(d_list = ., var = var, typical = TYPICAL, 
             segment = data.frame(x = c(0, 0.8, 14.8), 
                                  xend = c(0.2, 14.2, 28.2))) %>%
    mutate(source = if_else(source=="orgin", true = "Original", source)) %>%
    mutate(source = if_else(source=="miced", true = "Imputed", source)) %>%
    group_by(source, trt, x) %>%
    summarise(x= unique(x), xend = unique(xend), 
              Nt = mean(Nt, na.rm = TRUE),
              y = mean(y), yend = mean(yend)) %>%
    ungroup()
  d_list_RR_CI <- d_list_ATT %>% 
    pivot_wider(id_cols = c("source","x", "xend", "Nt"), 
                names_from = trt, values_from = y) %>%
    mutate(RR = `Smokers`/`Non-Smokers`,
           x0 = `Non-Smokers`*Nt, x1 = `Smokers`*Nt,
           n0 = Nt, n1 = Nt,
           CI_low = exp(log(RR) + (-1)*qnorm(0.975)*sqrt(1/x1 + 1/x0 - 1/n1 - 1/n0)),
           CI_high = exp(log(RR) + (+1)*qnorm(0.975)*sqrt(1/x1 + 1/x0 - 1/n1 - 1/n0))
    )
  d_list_RR_CI <- d_list_RR_CI %>% 
    mutate(notes = paste(
      "ATT = ", round(`Smokers`-`Non-Smokers`, digits = 3),"\n",
      "RR = ", round(RR, digits = 2), 
      if_else(source == "Imputed","", 
              paste(" (", round(CI_low, digits = 2), ", ", 
                    round(CI_high, digits = 2), ")", sep = "")),
      if_else(source == "Imputed", "", paste("\nN = ", Nt, sep = "")), 
      sep = "")
    ) %>%
    # mutate(RR = paste("ATT = ", round(`Smokers`-`Non-Smokers`, digits = 3),"\n",
    #                   "RR = ", round(RR, digits = 2), 
    #                   " (", round(CI_low, digits = 2), ", ",
    #                   round(CI_high, digits = 2), ")", sep = "")
    #        ) %>%
    mutate(y = if_else(source == "Imputed", `Smokers`     + 0.1, NA_real_),
           x = if_else(source == "Imputed",  (x+xend)/2   - 2  ,   x)) %>%
    mutate(y = if_else(source == "Original", `Non-Smokers`- 0.1, y       ),
           x = if_else(source == "Original", (x+xend)/2   + 2  ,   x))%>%
    select(source, x, y, Nt, RR, notes)
  d_list_prev <- d_list %>%
    tempfun6(d_list = ., var = var, typical = TYPICAL) %>% 
    group_by(num_missing_tooth, source) %>%
    dplyr::summarise(prev = mean(prev), sample_size = mean(sample_size)) %>%
    ungroup() %>%
    mutate(source = if_else(source=="orgin", true = "Original", source)) %>%
    mutate(source = if_else(source=="miced", true = "Imputed", source))
  ggplot()+
    geom_point(aes(x=num_missing_tooth, y=prev, 
                   color = source), 
               data = d_list_prev)+
    geom_segment(aes(x=x, xend=xend, 
                     y=y, yend = yend, 
                     color = source, 
                     linetype = trt), 
                 linewidth = 0.5,
                 data = d_list_ATT) +
    geom_label(aes(x=x, y=y, label = notes, color = source), 
               data = d_list_RR_CI, alpha = 0.5)+
    scale_linetype_manual(values = c("twodash", "solid"), 
                          labels=c("Non-Smokers\n(potential outcome)", "Smokers"),
                          name = "Smoking Status")+
    scale_color_manual(values = COLORS[c(1,2)],
                       name = "Missing data") +
    scale_x_continuous(name = "Number of lost teeth", 
                       breaks = c(0, 5, 10, 15, 20, 25, 30), limits = c(-3,30))+
    scale_y_continuous(name = ifelse(var == "S", "Prevelence of Severe cases", 
                                     "Prevelence of Moderate and Severe cases"), 
                       breaks = (if(var == "S") c(0, 0.25, 0.5) else 
                         c(0, 0.25, 0.5, 0.75, 1)), 
                       limits = c(-0.1, ifelse(var == "S", 0.7, 1.1)))+
    theme_bw()+ 
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank()) -> fig.temp
  return(fig.temp)
}
TYPICAL = 2
models = c("d_orgin", 
           str_replace("HPC//d_miced_cart_OHX_demo_Q4_numtooth_NUM.d",
                       "NUM", as.character(1:10)))
fig.temp1 <- tempfun7(var = "MS", TYPICAL = 2, d_list = d_list[models])
fig.temp1
ggsave("Manuscript//figures//ATT of smk (outcome moderate severe).jpeg", fig.temp1, 
       width = FIG.WIDTH, height = 0.75*FIG.WIDTH, dpi = 1000)
fig.temp2 <- tempfun7(var = "S", TYPICAL = 2, d_list = d_list[models])
fig.temp2
ggsave("Manuscript//figures//ATT of smk (outcome severe).jpeg", fig.temp2, 
       width = FIG.WIDTH, height = 0.75*FIG.WIDTH, dpi = 1000)
fig.temp <- lemon::grid_arrange_shared_legend(fig.temp1, fig.temp2, 
                                              ncol=2, position = "right", plot = TRUE)
ggsave("Manuscript//figures//ATT of smk.jpeg", fig.temp, 
       width = FIG.WIDTH*1.75, height = 0.75*FIG.WIDTH, dpi = 1000)


# var = "MS"
# d_list_ATT <- d_list %>% 
#   tempfun4(d_list = ., var = var, typical = TYPICAL, 
#            segment = data.frame(x = c(-0.5, 0.8, 7.8, 14.8), 
#                                 xend = c(0.5, 7.2, 14.2, 28.2))) %>% 
#   mutate(trt = paste(trt, source, sep=", "))
# d_list_prev <- d_list %>%
#   tempfun6(d_list = ., var = var, typical = TYPICAL) %>% 
#   group_by(num_missing_tooth, source) %>%
#   dplyr::summarise(prev = mean(prev), sample_size = mean(sample_size)) %>%
#   mutate(source = paste("Non-Smokers, ", source, sep = ""))
# ggplot()+
#   geom_point(aes(x=num_missing_tooth, y=prev, 
#                  color = source), 
#              data = d_list_prev)+
#   geom_segment(aes(x=x, xend=xend, 
#                    y=y, yend = yend,
#                    color = trt, 
#                    linetype = typical), 
#                data = d_list_ATT) +
#   scale_linetype_manual(values = c("dotted", "solid"))+
#   scale_color_manual(values = COLORS) +
#   xlab("Number of lost teeth")+ ylim(c(0,1)) +
#   ylab(ifelse(var == "S", "Prevelence of Severe cases", "Prevelence of Moderate and Severe cases")) + 
#   theme_bw() -> fig.temp1

# var = "MS"
# d_list_ATT <- d_list %>% 
#   tempfun4(d_list = ., var = var, typical = TYPICAL, 
#            segment = data.frame(x = c(-0.5, 0.8, 7.8, 14.8), 
#                                 xend = c(0.5, 7.2, 14.2, 28.2))) %>% 
#   mutate(trt = paste(trt, source, sep=", "))
# d_list_prev <- d_list %>%
#   tempfun6(d_list = ., var = var, typical = TYPICAL) %>% 
#   group_by(num_missing_tooth, source) %>%
#   dplyr::summarise(prev = mean(prev), sample_size = mean(sample_size)) %>%
#   mutate(source = paste("Non-Smokers, ", source, sep = ""))
# ggplot()+
#   geom_point(aes(x=num_missing_tooth, y=prev, 
#                  color = source), 
#              data = d_list_prev)+
#   geom_segment(aes(x=x, xend=xend, 
#                    y=y, yend = yend,
#                    color = trt, 
#                    linetype = typical), 
#                data = d_list_ATT) +
#   scale_linetype_manual(values = c("dotted", "solid"))+
#   scale_color_manual(values = COLORS) +
#   xlab("Number of lost teeth")+ ylim(c(0,1)) +
#   ylab(ifelse(var == "S", "Prevelence of Severe cases", "Prevelence of Moderate and Severe cases")) + 
#   theme_bw() -> fig.temp1


# tempfun <- function(d, B=100){
#   #caculate the ATE of the smk_stt on prondentist
#   ps_model <- glm(smk_stt ~ age + sex + race, data = d, family = "binomial")
#   ps <- predict(ps_model, type = "response")
#   ps_quintile <- cut(ps, 
#                      breaks = c(0, quantile(ps, p = c(0.2, 0.4, 0.6, 0.8)), 1), 
#                      labels = 1:5)
#   
#   nj <- table(ps_quintile)
#   N <- nrow(d)
#   te_quintile <- 
#     tapply(d$S[d$smk_stt == TRUE],
#            ps_quintile[d$smk_stt == TRUE], mean) -
#     tapply(d$S[d$smk_stt == FALSE], 
#            ps_quintile[d$smk_stt == FALSE], mean)
#   ATE <- sum(te_quintile *nj/N)
#   
#   for(i in 1:B) {
#     d.boot <- d[sample(1:n, n, replace = TRUE), ]
#     ps_model_d.boot <- glm(formula = formu, data = new_data_cleaned.boot, family = "binomial")
#     ps_d.boot <- predict(ps_model_d.boot, type = "response")
#     
#     ps_quintile.boot <- cut(ps_d.boot, 
#                             breaks = c(0, quantile(ps_d.boot, p = c(0.2, 0.4, 0.6, 0.8)), 1), labels = 1:5)
#     nj.boot <- table(ps_quintile.boot)
#     
#     te_quintile.boot <- 
#       tapply(new_data_cleaned.boot$Preg.ended[new_data_cleaned.boot$Group == "T"], 
#              ps_quintile.boot[new_data_cleaned.boot$Group == "T"], mean) -
#       tapply(new_data_cleaned.boot$Preg.ended[new_data_cleaned.boot$Group == "C"], 
#              ps_quintile.boot[new_data_cleaned.boot$Group == "C"], mean)
#     ATE.boot <- sum(te_quintile.boot *nj/n)
#     ATE_PSS.boot <- c(ATE_PSS.boot, ATE.boot)
#   }
#   SE_PSS <- sd(ATE_PSS.boot) 
#   CI_PSS <- ATE_PSS + c(-1, 1)*qnorm(0.975)*SE_PSS
#   
#   temp <- cbind(ATE_PSS, SE_PSS, t(CI_PSS))
#   colnames(temp) <- c("Estimated average (causal) treatment effect, PSS", "standard error", "95% CI lower bound", "95% CI upper bound")
#   
#   return(list(ATE = ATE))
# }
# 
# tempfun(d_orgin)
# tempfun(d_miced_list[[2]])


```

# Model construction and evaluation

-   Fit SVM classifiers using the imputed data set based on Ramfjord teeth

```{r, echo=FALSE, eval=FALSE, include=FALSE}
Ramfjord <- names(d_miced) %>% str_subset(pattern = "^ohx(03)|(09)|(12)|(19)|(25)|(28)")
Full_mouth <- names(d_miced) %>% str_subset(pattern = "^ohx")

# calculate_metrics <- function(data = c("Original","With MICE"), 
#                   method = c("Full Mouth", "naive Ramfjord", "SVM (Full Mouth)", "SVM (Ramfjord Teeth)"), 
#                   case = c("Severe", "Moderate-Severe"),
dataSet = c("Original","With MICE")
protocols = c("Full Mouth", "naive Ramfjord", "SVM (Full Mouth)", "SVM (Ramfjord Teeth)")
case = c("Severe", "Moderate-Severe")
metrics = c("Prevalence", "AUC", "Sensitivity", "Specificity", "F1-score", 
           "Diagnostic Odds Ratio")

evaluation_metrics <- array(data = NA, 
                            dim = c(length(metrics), length(protocols), 
                                    length(case), length(dataSet)),
                            dimnames = list(metrics = metrics, protocols = protocols, 
                                            case = case, dataSet = dataSet))
for(i in dataSet)
  for(j in protocols)
    for(k in case)
      evaluation_metrics[c("Prevalence", "AUC", "Sensitivity", "Specificity", "F1-score", 
                           "Diagnostic Odds Ratio"), j, k, i] <- 
  calculate_metrics(data = i, method = j, case = k, test.d_miced = test.d_miced, 
                    test.d_orgin = test.d_orgin, train.d_miced = train.d_miced, 
                    train.d_orgin = train.d_orgin, Ramfjord = Ramfjord, Full_mouth = Full_mouth
  )[c("Prevalence", "AUC", "Sensitivity", "Specificity", 
      "F1-score", "Diagnostic Odds Ratio")]
temp <- ftable(round(evaluation_metrics,digits = 2), row.vars = c("case", "metrics"), col.vars = c("dataSet", "protocols"))
write.table(stats:::format.ftable(temp, quote = FALSE), sep = ",", file = "Manuscript//figures//Metrics_table.csv")
```

```{r, eval=FALSE, include=FALSE}
##### outcome S, predictors are sites from Ramfjord teeth only
svm_S <- train.d_miced %>% mutate(S = as.numeric(S)) %>%
  svm(formula = as.formula(paste("S~", paste(Ramfjord,collapse="+"), collapse= "")),
      data= .)
pred <- prediction(predict(svm_S, type="response"), d_miced$S)
cat("AUC (cohort F) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
pred <- test.d_miced %>% mutate(S = as.numeric(S)) %>%
  predict(object = svm_S, newdata = ., type="response") %>%
  prediction(predictions = ., labels = test.d_miced$S)
cat("AUC (cohort G) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
perf <- performance(pred,"tpr","fpr")

temp <- test.d_miced %>% mutate(S = as.numeric(S)) %>% 
  predict(object = svm_S, newdata = ., type="response")
temp <-table(predictions = temp >= 0.5, test.d_miced$S)
cat(temp[1,1]/(temp[1,1]+temp[2,1]), temp[2,2]/(temp[2,2]+temp[1,2]))

performance(pred,"auc") # shows calculated AUC for model
plot(perf,colorize=FALSE, col="black") # plot ROC curve
lines(c(0,1),c(0,1),col = "gray", lty = 4 )
table(ram$S, test.d_miced$S) -> temp
points(x = temp[2,1]/(temp[1,1]+temp[2,1]), y = temp[2,2]/(temp[2,2]+temp[1,2]))

#Full-mouth
svm_S <- d_miced %>% mutate(S = as.numeric(S)) %>% 
  svm(formula = as.formula(paste("S~", paste(Full_mouth,collapse="+"), collapse= "")),
      data= .)
pred <- prediction(predict(svm_S, type="response"), d_miced$S)
cat("AUC (cohort F) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
pred <- test.d_miced %>% mutate(S = as.numeric(S)) %>%
  predict(object = svm_S, newdata = ., type="response") %>%
  prediction(predictions = ., labels = test.d_miced$S)
cat("AUC (cohort G) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
perf <- performance(pred,"tpr","fpr")
temp <- test.d_miced %>% mutate(S = as.numeric(S)) %>% 
  predict(object = svm_S, newdata = ., type="response")
temp <-table(predictions = temp >= 0.5, test.d_miced$S)
cat(temp[1,1]/(temp[1,1]+temp[2,1]), temp[2,2]/(temp[2,2]+temp[1,2]))
performance(pred,"auc") # shows calculated AUC for model
plot(perf,colorize=FALSE, col="black") # plot ROC curve
lines(c(0,1),c(0,1),col = "gray", lty = 4 )
table(ram$S, test.d_miced$S) -> temp
points(x = temp[2,1]/(temp[1,1]+temp[2,1]), y = temp[2,2]/(temp[2,2]+temp[1,2]))



##### outcome MS, predictors are sites from Ramfjord teeth only
svm_MS <- d_miced %>% mutate(MS = as.numeric(MS)) %>%
  svm(formula = as.formula(paste("MS~", paste(Ramfjord,collapse="+"), collapse= "")),
      data= .)
pred <- prediction(predict(svm_MS, type="response"), d_miced$MS)
cat("AUC (cohort F) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
pred <- test.d_miced %>% mutate(MS = as.numeric(MS)) %>%
  predict(object = svm_MS, newdata = ., type="response") %>%
  prediction(predictions = ., labels = test.d_miced$MS)
cat("AUC (cohort G) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
perf <- performance(pred,"tpr","fpr")
performance(pred,"auc") # shows calculated AUC for model
plot(perf,colorize=FALSE, col="black") # plot ROC curve
lines(c(0,1),c(0,1),col = "gray", lty = 4)
table(ram$MS, test.d_miced$MS) -> temp
points(x = temp[2,1]/(temp[1,1]+temp[2,1]), y = temp[2,2]/(temp[2,2]+temp[1,2]))

temp <- test.d_miced %>% mutate(MS = as.numeric(MS)) %>% 
  predict(object = svm_MS, newdata = ., type="response")
temp <-table(predictions = temp >= 0.5, test.d_miced$MS)
cat(temp[1,1]/(temp[1,1]+temp[2,1]), temp[2,2]/(temp[2,2]+temp[1,2]))

#Full-month
svm_MS <- d_miced %>% mutate(MS = as.numeric(MS)) %>%
  svm(formula = as.formula(paste("MS~", paste(Full_mouth,collapse="+"), collapse= "")),
      data= .)
pred <- prediction(predict(svm_MS, type="response"), d_miced$MS)
cat("AUC (cohort F) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
pred <- test.d_miced %>% mutate(MS = as.numeric(MS)) %>%
  predict(object = svm_MS, newdata = ., type="response") %>%
  prediction(predictions = ., labels = test.d_miced$MS)
cat("AUC (cohort G) = ", round(performance(pred,"auc")@y.values[[1]], digits = 4))
perf <- performance(pred,"tpr","fpr")
performance(pred,"auc") # shows calculated AUC for model
plot(perf,colorize=FALSE, col="black") # plot ROC curve
lines(c(0,1),c(0,1),col = "gray", lty = 4)
table(ram$MS, test.d_miced$MS) -> temp
points(x = temp[2,1]/(temp[1,1]+temp[2,1]), y = temp[2,2]/(temp[2,2]+temp[1,2]))

temp <- test.d_miced %>% mutate(MS = as.numeric(MS)) %>% 
  predict(object = svm_MS, newdata = ., type="response")
temp <-table(predictions = temp >= 0.5, test.d_miced$MS)
cat(temp[1,1]/(temp[1,1]+temp[2,1]), temp[2,2]/(temp[2,2]+temp[1,2]))
```
